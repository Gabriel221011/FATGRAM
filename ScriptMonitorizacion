#!/bin/bash
# ------------------------------------------------------------
# Script: monitor_servicios.sh
# Autor: ChatGPT
# Descripción:
#   Script en Bash para Debian que monitoriza servicios web
#   con dos modos de funcionamiento:
#     1) Manual (menú interactivo)
#     2) Automático (pensado para cron)
#   - Permite monitorizar uno o varios servicios
#   - Permite iniciar y parar servicios
#   - Genera fichero de estado y fichero de log en ambos modos
#   - Usa rutas dinámicas y está comentado
# ------------------------------------------------------------

# =========================
# VARIABLES DINÁMICAS
# =========================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DATE_NOW="$(date '+%Y-%m-%d %H:%M:%S')"
LOG_DIR="$SCRIPT_DIR/logs"
STATE_DIR="$SCRIPT_DIR/estado"
LOG_FILE="$LOG_DIR/monitor.log"
STATE_FILE="$STATE_DIR/estado_servicios.txt"

# Crear directorios si no existen
mkdir -p "$LOG_DIR" "$STATE_DIR"

# =========================
# SERVICIOS A MONITORIZAR
# (puedes añadir más)
# =========================
SERVICIOS_WEB=(
  "apache2"
  "nginx"
)

# =========================
# FUNCIÓN LOG
# =========================
log_msg() {
  echo "[$DATE_NOW] $1" | tee -a "$LOG_FILE"
}

# =========================
# FUNCIÓN COMPROBAR SERVICIO
# =========================
check_service() {
  local servicio=$1
  if systemctl is-active --quiet "$servicio"; then
    echo "$servicio: ACTIVO" | tee -a "$STATE_FILE"
    log_msg "Servicio $servicio ACTIVO"
  else
    echo "$servicio: INACTIVO" | tee -a "$STATE_FILE"
    log_msg "Servicio $servicio INACTIVO"
  fi
}

# =========================
# INICIAR SERVICIO
# =========================
start_service() {
  local servicio=$1
  systemctl start "$servicio" && log_msg "Servicio $servicio INICIADO"
}

# =========================
# PARAR SERVICIO
# =========================
stop_service() {
  local servicio=$1
  systemctl stop "$servicio" && log_msg "Servicio $servicio PARADO"
}

# =========================
# MODO AUTOMÁTICO (CRON)
# =========================
auto_mode() {
  echo "===== ESTADO SERVICIOS ($DATE_NOW) =====" > "$STATE_FILE"
  for s in "${SERVICIOS_WEB[@]}"; do
    check_service "$s"
  done
}

# =========================
# MENÚ MANUAL
# =========================
manual_menu() {
  while true; do
    clear
    echo "===== MENÚ MONITORIZACIÓN ====="
    echo "1) Monitorizar TODOS los servicios"
    echo "2) Monitorizar UN servicio"
    echo "3) Iniciar un servicio"
    echo "4) Parar un servicio"
    echo "5) Salir"
    echo ""
    read -p "Selecciona una opción: " opt

    case $opt in
      1)
        echo "===== ESTADO SERVICIOS ($DATE_NOW) =====" > "$STATE_FILE"
        for s in "${SERVICIOS_WEB[@]}"; do
          check_service "$s"
        done
        read -p "Pulsa ENTER para continuar";;

      2)
        read -p "Nombre del servicio: " svc
        echo "===== ESTADO SERVICIO ($DATE_NOW) =====" > "$STATE_FILE"
        check_service "$svc"
        read -p "Pulsa ENTER para continuar";;

      3)
        read -p "Servicio a iniciar: " svc
        start_service "$svc"
        read -p "Pulsa ENTER para continuar";;

      4)
        read -p "Servicio a parar: " svc
        stop_service "$svc"
        read -p "Pulsa ENTER para continuar";;

      5)
        log_msg "Salida del modo manual"
        exit 0;;

      *)
        echo "Opción no válida"
        sleep 1;;
    esac
  done
}

# =========================
# MAIN
# =========================
if [[ "$1" == "auto" ]]; then
  auto_mode
else
  manual_menu
fi
