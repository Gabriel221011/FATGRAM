# 1. Definición del grupo de servidores (Upstream)
upstream mis_servidores_web {
    fair;
    # El parámetro max_fails y fail_timeout controlan cuándo Nginx marca un server como "caído"
    server 10.0.128.56:80 max_fails=3 fail_timeout=5s;
    server 10.0.128.20:80 max_fails=3 fail_timeout=5s;
}

# 2. Servidor Principal (HTTPS - Puerto 443)
server {
    listen 443 ssl;
    server_name fatgram.ddns.net;
    
    # --- RUTAS DE CERTIFICADOS (Certbot) ---
    ssl_certificate /etc/letsencrypt/live/fatgram.ddns.net/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/fatgram.ddns.net/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Configuración de la raíz (opcional si usas proxy_pass en todo)
    root /var/www/html;
    index index.php index.html;

    location / {
        # Enviamos el tráfico al upstream definido arriba
        proxy_pass http://mis_servidores_web;

        # --- CONFIGURACIÓN DE REINTENTOS (FAILOVER RÁPIDO) ---
        # Si un server tarda más de 3s en conectar, pasa al siguiente
        proxy_connect_timeout      3s;
        proxy_send_timeout         3s;
        proxy_read_timeout         3s;
        
        # Indica en qué casos saltar al segundo servidor sin mostrar error al usuario
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

        # --- CABECERAS DE IDENTIDAD ---
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;

        # --- OPTIMIZACIÓN DE BUFFERS ---
        proxy_buffer_size          128k;
        proxy_buffers              4 256k;
        proxy_busy_buffers_size    256k;

        # --- FIX PARA COOKIES (phpMyAdmin / Sesiones) ---
        proxy_cookie_path / "/; secure; HttpOnly";
    }
}

# 3. Redirección de Seguridad (HTTP a HTTPS)
server {
    listen 80;
    server_name fatgram.ddns.net;

    # Redirige todo el tráfico de texto plano a la versión segura
    if ($host = fatgram.ddns.net) {
        return 301 https://$host$request_uri;
    }

    return 404; 
}